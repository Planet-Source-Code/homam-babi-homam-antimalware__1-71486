VERSION 5.00
Begin VB.Form frmAlert 
   AutoRedraw      =   -1  'True
   BackColor       =   &H00FFFFFF&
   BorderStyle     =   0  'None
   ClientHeight    =   6330
   ClientLeft      =   5745
   ClientTop       =   3870
   ClientWidth     =   3060
   ControlBox      =   0   'False
   BeginProperty Font 
      Name            =   "Tahoma"
      Size            =   8.25
      Charset         =   178
      Weight          =   400
      Underline       =   0   'False
      Italic          =   0   'False
      Strikethrough   =   0   'False
   EndProperty
   ForeColor       =   &H00FFFFFF&
   Icon            =   "frmAlert.frx":0000
   LinkTopic       =   "frmAlert"
   LockControls    =   -1  'True
   MaxButton       =   0   'False
   MinButton       =   0   'False
   Moveable        =   0   'False
   ScaleHeight     =   6330
   ScaleWidth      =   3060
   ShowInTaskbar   =   0   'False
   Visible         =   0   'False
   Begin VB.PictureBox picX 
      Appearance      =   0  'Flat
      AutoRedraw      =   -1  'True
      BackColor       =   &H80000005&
      DrawWidth       =   2
      ForeColor       =   &H80000008&
      Height          =   150
      Left            =   2775
      ScaleHeight     =   120
      ScaleWidth      =   120
      TabIndex        =   4
      Top             =   105
      Width           =   150
   End
   Begin VB.CommandButton cmdDelete 
      BackColor       =   &H00C8FFFF&
      Caption         =   "Delete"
      Height          =   330
      Left            =   1620
      TabIndex        =   1
      Top             =   1260
      Visible         =   0   'False
      Width           =   855
   End
   Begin VB.CommandButton cmdIgnore 
      BackColor       =   &H00C8FFFF&
      Caption         =   "Ignore"
      Height          =   330
      Left            =   540
      TabIndex        =   2
      Top             =   1260
      Visible         =   0   'False
      Width           =   855
   End
   Begin VB.PictureBox picWarn 
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   178
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   615
      Left            =   1560
      Picture         =   "frmAlert.frx":000C
      ScaleHeight     =   555
      ScaleWidth      =   555
      TabIndex        =   6
      TabStop         =   0   'False
      Top             =   2160
      Width           =   615
   End
   Begin VB.PictureBox picNo 
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   178
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   615
      Left            =   840
      Picture         =   "frmAlert.frx":0B2E
      ScaleHeight     =   555
      ScaleWidth      =   555
      TabIndex        =   5
      TabStop         =   0   'False
      Top             =   2160
      Width           =   615
   End
   Begin VB.PictureBox picOK 
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   178
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   615
      Left            =   120
      Picture         =   "frmAlert.frx":24B0
      ScaleHeight     =   555
      ScaleWidth      =   555
      TabIndex        =   0
      Top             =   2160
      Width           =   615
   End
   Begin VB.Timer Timer1 
      Interval        =   1
      Left            =   2280
      Top             =   2160
   End
   Begin VB.Label lblStill 
      Alignment       =   2  'Center
      Caption         =   "But they weren't deleted"
      BeginProperty Font 
         Name            =   "Tahoma"
         Size            =   8.25
         Charset         =   178
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   255
      Index           =   3
      Left            =   120
      TabIndex        =   16
      Top             =   5640
      Width           =   2415
   End
   Begin VB.Label lblStill 
      Alignment       =   2  'Center
      Caption         =   "detected"
      Height          =   255
      Index           =   2
      Left            =   120
      TabIndex        =   15
      Top             =   5400
      Width           =   2415
   End
   Begin VB.Label lblStill 
      Alignment       =   2  'Center
      Caption         =   "Suspected files have been"
      Height          =   255
      Index           =   1
      Left            =   120
      TabIndex        =   14
      Top             =   5160
      Width           =   2415
   End
   Begin VB.Label lblFound 
      Alignment       =   2  'Center
      Caption         =   "C:\Autorun.exe"
      BeginProperty Font 
         Name            =   "Tahoma"
         Size            =   8.25
         Charset         =   178
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H000000C0&
      Height          =   255
      Index           =   2
      Left            =   120
      TabIndex        =   13
      Top             =   4800
      Width           =   2415
   End
   Begin VB.Label lblFound 
      Alignment       =   2  'Center
      Caption         =   "A suspected file is found:"
      Height          =   255
      Index           =   1
      Left            =   120
      TabIndex        =   12
      Top             =   4560
      Width           =   2415
   End
   Begin VB.Label lblDeleted 
      Alignment       =   2  'Center
      Caption         =   "And were successfully eliminated"
      BeginProperty Font 
         Name            =   "Tahoma"
         Size            =   8.25
         Charset         =   178
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   495
      Index           =   3
      Left            =   120
      TabIndex        =   11
      Top             =   3960
      Width           =   2415
   End
   Begin VB.Label lblDeleted 
      Alignment       =   2  'Center
      Caption         =   "detected"
      Height          =   255
      Index           =   2
      Left            =   120
      TabIndex        =   10
      Top             =   3720
      Width           =   2415
   End
   Begin VB.Label lblDeleted 
      Alignment       =   2  'Center
      Caption         =   "Suspected files have been"
      Height          =   255
      Index           =   1
      Left            =   120
      TabIndex        =   9
      Top             =   3480
      Width           =   2415
   End
   Begin VB.Label lblClean 
      Alignment       =   2  'Center
      Caption         =   "Your computer is clean"
      BeginProperty Font 
         Name            =   "Tahoma"
         Size            =   8.25
         Charset         =   178
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   255
      Index           =   2
      Left            =   120
      TabIndex        =   8
      Top             =   3120
      Width           =   2415
   End
   Begin VB.Label lblClean 
      Alignment       =   2  'Center
      Caption         =   "A scan has been done"
      Height          =   255
      Index           =   1
      Left            =   120
      TabIndex        =   7
      Top             =   2880
      Width           =   2415
   End
   Begin VB.Image imgIcon 
      Height          =   480
      Left            =   135
      Top             =   480
      Width           =   480
   End
   Begin VB.Label lblApp 
      AutoSize        =   -1  'True
      BackStyle       =   0  'Transparent
      BeginProperty Font 
         Name            =   "Tahoma"
         Size            =   8.25
         Charset         =   178
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   195
      Left            =   360
      TabIndex        =   3
      Top             =   75
      Width           =   45
   End
   Begin VB.Image imgApp 
      Height          =   240
      Left            =   60
      Picture         =   "frmAlert.frx":3E32
      Top             =   60
      Width           =   240
   End
End
Attribute VB_Name = "frmAlert"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit

'[Dec 2008] - Updated By Homam Babi - humam_babi@yahoo.com - Syria
'[Dec 2004] - UPDATED BY REDA AL MASRT - MASRYSOFT@YAHOO.COM - EGYPT

Private Const IDS_MSG_SURE_IGNORE = 200

Private Const SPI_GETWORKAREA As Long = 48&
Private Const LWA_ALPHA     As Long = &H2
Private Const GWL_EXSTYLE   As Long = (-20)
Private Const WS_EX_LAYERED As Long = &H80000
Private Const DISPLAY_TIME = 3
Private Const TOP_CONST = 45
Private Const SND_RESOURCE = &H40004
Private Const SND_ASYNC = &H1
Private Const SND_NODEFAULT = &H2

Private Const ME_HEIGHT = 1740
Private Const ME_WIDTH = 3015

Private Type RECT
    Left   As Long
    Top    As Long
    Right  As Long
    Bottom As Long
End Type

Private m_lChangeSpeed  As Long
Private m_lCounter      As Long
Private m_lColXn        As Long
Private m_lColXm        As Long
Private m_lFile         As String
Private m_lState        As TypesOfAlert
Private scrBtm          As Long
Private m_bSlide        As Boolean
Private m_bOnTop        As Boolean

Private Declare Function SystemParametersInfo Lib "user32" Alias "SystemParametersInfoA" (ByVal uAction As Long, ByVal uParam As Long, ByRef lpvParam As Any, ByVal fuWinIni As Long) As Long
Private Declare Function SetWindowPos Lib "user32" (ByVal hWnd As Long, ByVal hWndInsertAfter As Long, ByVal X As Long, ByVal Y As Long, ByVal cX As Long, ByVal cY As Long, ByVal wFlags As Long) As Long
Private Declare Function GetWindowLong Lib "user32" Alias "GetWindowLongA" (ByVal hWnd As Long, ByVal nIndex As Long) As Long
Private Declare Function SetLayeredWindowAttributes Lib "user32" (ByVal hWnd As Long, ByVal crKey As Long, ByVal bAlpha As Byte, ByVal dwFlags As Long) As Long
Private Declare Function PlaySound Lib "winmm.dll" Alias "PlaySoundA" (ByVal lpszName As String, ByVal hModule As Long, ByVal dwFlags As Long) As Long
Private Sub Form_Load()
    Dim wRect   As RECT
    Dim fLeft   As Long
    
    'Get the left & top positions of the form
    Call SystemParametersInfo(SPI_GETWORKAREA, 0&, wRect, 0&)
    scrBtm = wRect.Bottom * Screen.TwipsPerPixelY
    fLeft = (wRect.Right * Screen.TwipsPerPixelX) - ME_WIDTH
    
    'Assign them
    Me.Move fLeft, scrBtm, ME_WIDTH, ME_HEIGHT
    
    lblApp.Caption = LoadResString(IDS_APP_NAME)
    
    Alerting = True
    frmNotify.mnuScan.Enabled = False
    frmNotify.mnuSettings.Enabled = False
End Sub
Public Sub DisplayMessage(msgType As TypesOfAlert, Optional ByVal strMalFile As String)
    Dim clrBack     As Long
    Dim clrBorder   As Long
    Dim clrSep      As Long
    Dim clrTitle    As Long
    
    Alerting = True
    frmNotify.mnuScan.Enabled = False
    frmNotify.mnuSettings.Enabled = False

    m_lCounter = DISPLAY_TIME * 100&
    m_lState = msgType
    m_lFile = strMalFile
    
    Load Me
    m_bSlide = GetSetting(LoadResString(IDS_REG_APP_NAME), LoadResString(IDS_REG_SECTION_SETTINGS), LoadResString(IDS_REG_KEY_MSG_STYLE), True)
    
    If m_bSlide = False Then
         'Fade
        m_lChangeSpeed = 100& '100% transparent
        Me.Top = scrBtm - ME_HEIGHT
        
        Call MakeTransparent(m_lChangeSpeed)
        Call SetOnTop(True)
    Else 'Slide
        m_lChangeSpeed = 75&
    End If

    If msgType = Clean Then
        lblClean(1).Move imgIcon.Left + imgIcon.Width, (365 + ((Me.Height - 365) / 2)) - lblClean(1).Height
        lblClean(2).Move imgIcon.Left + imgIcon.Width, (365 + ((Me.Height - 365) / 2))

        lblClean(1).BackStyle = vbTransparent
        lblClean(2).BackStyle = vbTransparent
        
        imgIcon.Picture = picOK.Picture
        imgIcon.Top = ((365 + ((Me.Height - 365) / 2)) - (imgIcon.Height / 2)) - TOP_CONST
        
        clrBack = RGB(230, 255, 230)
        clrBorder = RGB(100, 200, 100)
        clrSep = RGB(150, 240, 150)
        clrTitle = RGB(0, 150, 0)
    ElseIf msgType = Deleted Then
        lblDeleted(1).Move imgIcon.Left + imgIcon.Width, (365 + ((Me.Height - 365) / 2)) - ((lblDeleted(1).Height + lblDeleted(2).Height + lblDeleted(3).Height) / 2)
        lblDeleted(2).Move imgIcon.Left + imgIcon.Width, lblDeleted(1).Top + lblDeleted(1).Height
        lblDeleted(3).Move imgIcon.Left + imgIcon.Width, lblDeleted(2).Top + lblDeleted(2).Height
                
        lblDeleted(1).BackStyle = vbTransparent
        lblDeleted(2).BackStyle = vbTransparent
        lblDeleted(3).BackStyle = vbTransparent
        
        imgIcon.Picture = picOK.Picture
        imgIcon.Top = ((365 + ((Me.Height - 365) / 2)) - (imgIcon.Height / 2)) - TOP_CONST
        
        clrBack = RGB(230, 255, 230)
        clrBorder = RGB(100, 200, 100)
        clrSep = RGB(150, 240, 150)
        clrTitle = RGB(0, 150, 0)
    ElseIf msgType = Found Then
        lblFound(1).Move imgIcon.Left + imgIcon.Width, 570
        lblFound(2).Move imgIcon.Left + imgIcon.Width, lblFound(1).Top + lblFound(1).Height
        
        lblFound(1).BackStyle = vbTransparent
        lblFound(2).BackStyle = vbTransparent
        lblFound(2).Caption = strMalFile
        
        imgIcon.Picture = picWarn.Picture
        imgIcon.Top = 570
        
        clrBack = RGB(255, 255, 210)
        clrBorder = RGB(230, 230, 0)
        clrSep = RGB(255, 255, 0)
        clrTitle = RGB(170, 170, 0)
    ElseIf msgType = Still Then
        lblStill(1).Move imgIcon.Left + imgIcon.Width, (365 + ((Me.Height - 365) / 2)) - (lblDeleted(1).Height + (lblDeleted(2).Height / 2))
        lblStill(2).Move imgIcon.Left + imgIcon.Width, (365 + ((Me.Height - 365) / 2)) - (lblDeleted(2).Height / 2)
        lblStill(3).Move imgIcon.Left + imgIcon.Width, (365 + ((Me.Height - 365) / 2)) + (lblDeleted(2).Height / 2)
        
        lblStill(1).BackStyle = vbTransparent
        lblStill(2).BackStyle = vbTransparent
        lblStill(3).BackStyle = vbTransparent
        
        imgIcon.Picture = picNo.Picture
        imgIcon.Top = ((365 + ((Me.Height - 365) / 2)) - (imgIcon.Height / 2)) - TOP_CONST
        
        clrBack = RGB(250, 235, 230)
        clrBorder = RGB(200, 100, 100)
        clrSep = RGB(240, 150, 150)
        clrTitle = RGB(150, 0, 0)
    End If
                
    
    'Add colored background
    Me.BackColor = clrBack
    
    'Draw Square borders around the Form
    Me.Line (Me.Width - 15, Me.Height - 15)-(Me.Width - 15, 0), clrBorder
    Me.Line (Me.Width - 15, Me.Height - 15)-(0, Me.Height - 15), clrBorder
    Me.Line (Me.ScaleWidth - 1, 0)-(0, 0), clrBorder
    Me.Line (0, Me.Height - 15)-(0, 0), clrBorder

    Me.Line (15, 15)-(Me.Width - 30, Me.Height - 30), vbWhite, B
    
    Me.Line (15, 350)-(Me.Width - 30, 350), clrSep
    Me.Line (15, 365)-(Me.Width - 30, 365), vbWhite
    
    If msgType = Found Then
        cmdDelete.Visible = True
        cmdIgnore.Visible = True
    Else
        cmdDelete.Visible = False
        cmdIgnore.Visible = False
    End If
    
    lblApp.ForeColor = clrTitle
    m_lColXn = clrTitle
    m_lColXm = clrBorder

    picX.BorderStyle = 0
    picX.BackColor = clrBack
    picX.Line (0, 0)-(120, 120), IIf(msgType = Found, RGB(200, 200, 200), m_lColXn)
    picX.Line (0, 120)-(120, 0), IIf(msgType = Found, RGB(200, 200, 200), m_lColXn)
    
    Me.Show
    
    Timer1.Enabled = True
    
    sndAlert m_lState
End Sub
Private Sub lblApp_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Call Form_MouseMove(Button, Shift, X, Y)
End Sub
Private Sub picX_Click()
    If m_lState <> Found Then m_lCounter = 0
End Sub
Private Sub picX_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    picX.Line (0, 0)-(120, 120), IIf(m_lState = Found, RGB(200, 200, 200), m_lColXm)
    picX.Line (0, 120)-(120, 0), IIf(m_lState = Found, RGB(200, 200, 200), m_lColXm)
End Sub
Private Sub Form_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    picX.Line (0, 0)-(120, 120), IIf(m_lState = Found, RGB(200, 200, 200), m_lColXn)
    picX.Line (0, 120)-(120, 0), IIf(m_lState = Found, RGB(200, 200, 200), m_lColXn)
End Sub
Private Sub Timer1_Timer()
    If m_bSlide = False Then  'Fade
        If m_lCounter > 0 Then  'Fade In then Wait
            If m_lChangeSpeed > 0 Then
                m_lChangeSpeed = m_lChangeSpeed - 4
                Call MakeTransparent(m_lChangeSpeed)
            Else
                'Wait
                If m_lState <> Found Then m_lCounter = m_lCounter - 1
            End If
            If Ending Then m_lCounter = 0
        Else 'Fade Out then Close
            If m_lChangeSpeed <= 100 Then
                'Fade out
                m_lChangeSpeed = m_lChangeSpeed + 4
                Call MakeTransparent(m_lChangeSpeed)
            Else
                Unload Me
            End If
        End If
    Else 'Slide
        If m_lCounter > 0 Then 'Move Up then Wait
            If Me.Top > 0 And Me.Top > scrBtm - ME_HEIGHT Then
                'Move Up
                Me.Top = Me.Top - m_lChangeSpeed
            Else
                'Wait
                If Not m_bOnTop Then
                    Me.Top = scrBtm - ME_HEIGHT
                    m_bOnTop = True
                    Call SetOnTop(m_bOnTop)
                End If
                If m_lState <> Found Then m_lCounter = m_lCounter - 1
            End If
            If Ending Then m_lCounter = 0
        Else 'Move Down then Close
            If Me.Top <= Screen.Height Then
                'Move Down
                 If m_bOnTop Then
                     m_bOnTop = False
                     Call SetOnTop(m_bOnTop)
                 End If
                Me.Top = Me.Top + m_lChangeSpeed
            Else
                Unload Me
            End If
        End If
    End If
End Sub
Private Sub Form_Unload(Cancel As Integer)
    If Ending Then End
    
    If m_lState <> Found Then
        Alerting = False
        frmNotify.mnuScan.Enabled = True
        frmNotify.mnuSettings.Enabled = True
    End If
    Set frmAlert = Nothing
End Sub
Private Sub SetOnTop(Optional ByVal bSetOnTop As Boolean = True)
    Const Flags As Long = &H273 'SWP_NOACTIVATE Or SWP_SHOWWINDOW Or SWP_NOMOVE Or SWP_NOSIZE or SWP_NOOWNERZORDER Or SWP_FRAMECHANGED
    
    If bSetOnTop Then
        Call SetWindowPos(Me.hWnd, -1, 0, 0, 0, 0, Flags)
    Else
        Call SetWindowPos(Me.hWnd, -2, 0, 0, 0, 0, Flags)
    End If
End Sub
Private Sub MakeTransparent(ByVal PercentTransparent As Long)
    Dim Ret As Long
      
    On Error Resume Next
        
    'Convert 0-100 to 255-0
    PercentTransparent = ((100& - PercentTransparent) / 100&) * 255&
        
    If PercentTransparent >= 0& And PercentTransparent <= 255& Then
        Ret = GetWindowLong(Me.hWnd, GWL_EXSTYLE)
        Ret = Ret Or WS_EX_LAYERED
        Call SetWindowLong(Me.hWnd, GWL_EXSTYLE, Ret)
        Call SetLayeredWindowAttributes(Me.hWnd, 0&, PercentTransparent, LWA_ALPHA)
    End If
End Sub
Private Sub cmdDelete_Click()
    cmdDelete.Enabled = False
    cmdIgnore.Enabled = False
    Delete m_lFile
    If FileExists(m_lFile) Then
        VirusDeleted = False
    End If
    
    Alerting = False
    frmNotify.mnuScan.Enabled = True
    frmNotify.mnuSettings.Enabled = True

    m_lCounter = 0
End Sub
Private Sub cmdIgnore_Click()
    If MsgBox(LoadResString(IDS_MSG_SURE_IGNORE), vbApplicationModal Or vbDefaultButton2 Or vbExclamation Or vbYesNo, LoadResString(IDS_APP_NAME)) = vbYes Then
        cmdIgnore.Enabled = False
        cmdDelete.Enabled = False
        VirusDeleted = False
        Alerting = False
        frmNotify.mnuScan.Enabled = True
        frmNotify.mnuSettings.Enabled = True

        m_lCounter = 0
    End If
End Sub
Private Sub sndAlert(ByVal sndType As TypesOfAlert)
    Dim R As Long
    
    If sndType = Clean Then
        R = PlaySound("WAV_CLEAN", App.hInstance, SND_RESOURCE Or SND_ASYNC Or SND_NODEFAULT)
    ElseIf sndType = Deleted Then
        R = PlaySound("WAV_DELETED", App.hInstance, SND_RESOURCE Or SND_ASYNC Or SND_NODEFAULT)
    ElseIf sndType = Found Then
        R = PlaySound("WAV_FOUND", App.hInstance, SND_RESOURCE Or SND_ASYNC Or SND_NODEFAULT)
    ElseIf sndType = Still Then
        R = PlaySound("WAV_STILL", App.hInstance, SND_RESOURCE Or SND_ASYNC Or SND_NODEFAULT)
    End If
End Sub
