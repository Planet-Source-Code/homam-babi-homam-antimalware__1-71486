VERSION 5.00
Begin VB.Form frmMain 
   AutoRedraw      =   -1  'True
   BackColor       =   &H80000005&
   BorderStyle     =   3  'Fixed Dialog
   Caption         =   "Homam AntiMalware Setup"
   ClientHeight    =   3600
   ClientLeft      =   45
   ClientTop       =   435
   ClientWidth     =   5355
   BeginProperty Font 
      Name            =   "Tahoma"
      Size            =   8.25
      Charset         =   178
      Weight          =   400
      Underline       =   0   'False
      Italic          =   0   'False
      Strikethrough   =   0   'False
   EndProperty
   Icon            =   "frmMain.frx":0000
   LinkTopic       =   "Form1"
   LockControls    =   -1  'True
   MaxButton       =   0   'False
   ScaleHeight     =   3600
   ScaleWidth      =   5355
   StartUpPosition =   2  'CenterScreen
   Begin VB.PictureBox picFinish 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      ForeColor       =   &H80000008&
      Height          =   2655
      Left            =   3960
      ScaleHeight     =   2625
      ScaleWidth      =   3705
      TabIndex        =   14
      Top             =   3960
      Width           =   3735
      Begin VB.CheckBox chkRestart 
         BackColor       =   &H80000005&
         Caption         =   "Restart the computer"
         Height          =   255
         Left            =   480
         TabIndex        =   18
         Top             =   1560
         Value           =   1  'Checked
         Width           =   2280
      End
      Begin VB.Label Label8 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "for the new settings to be applied."
         Height          =   195
         Left            =   120
         TabIndex        =   17
         Top             =   1080
         Width           =   2490
      End
      Begin VB.Label Label7 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "The program needs to restart your computer"
         Height          =   195
         Left            =   120
         TabIndex        =   16
         Top             =   840
         Width           =   3225
      End
      Begin VB.Label Label6 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "Installation was completed successfully."
         BeginProperty Font 
            Name            =   "Tahoma"
            Size            =   8.25
            Charset         =   178
            Weight          =   700
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Height          =   195
         Left            =   120
         TabIndex        =   15
         Top             =   360
         Width           =   3405
      End
   End
   Begin VB.PictureBox picAction 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      ForeColor       =   &H80000008&
      Height          =   2655
      Left            =   120
      ScaleHeight     =   2625
      ScaleWidth      =   3705
      TabIndex        =   9
      Top             =   3960
      Width           =   3735
      Begin VB.PictureBox picProgress 
         Appearance      =   0  'Flat
         AutoRedraw      =   -1  'True
         BackColor       =   &H80000005&
         Enabled         =   0   'False
         ForeColor       =   &H80000008&
         Height          =   285
         Left            =   120
         ScaleHeight     =   255
         ScaleWidth      =   3405
         TabIndex        =   10
         Top             =   1920
         Width           =   3435
      End
      Begin VB.PictureBox picPercent 
         Appearance      =   0  'Flat
         AutoRedraw      =   -1  'True
         BackColor       =   &H80000005&
         ForeColor       =   &H80000008&
         Height          =   255
         Left            =   2820
         ScaleHeight     =   225
         ScaleWidth      =   705
         TabIndex        =   12
         Top             =   1680
         Width           =   735
      End
      Begin VB.Label lblAction 
         BackStyle       =   0  'Transparent
         Caption         =   "Installing files..."
         Height          =   255
         Left            =   120
         TabIndex        =   13
         Top             =   1675
         Width           =   2295
      End
      Begin VB.Label Label5 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "Installing..."
         Height          =   195
         Left            =   120
         TabIndex        =   11
         Top             =   480
         Width           =   825
      End
   End
   Begin VB.PictureBox picControl 
      BorderStyle     =   0  'None
      Height          =   735
      Left            =   0
      ScaleHeight     =   735
      ScaleWidth      =   5415
      TabIndex        =   0
      Top             =   3000
      Width           =   5415
      Begin VB.CommandButton cmdExit 
         Cancel          =   -1  'True
         Caption         =   "Exit"
         Height          =   400
         Left            =   4280
         TabIndex        =   2
         Top             =   120
         Width           =   1000
      End
      Begin VB.CommandButton cmdSetup 
         Caption         =   "Install"
         Default         =   -1  'True
         Height          =   400
         Left            =   3240
         TabIndex        =   1
         Top             =   120
         Width           =   1000
      End
      Begin VB.Label lblDark 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "Homam babi"
         ForeColor       =   &H80000010&
         Height          =   195
         Left            =   255
         TabIndex        =   7
         Top             =   195
         Width           =   870
      End
      Begin VB.Line Line1 
         BorderColor     =   &H80000010&
         X1              =   0
         X2              =   5400
         Y1              =   0
         Y2              =   0
      End
      Begin VB.Line Line2 
         BorderColor     =   &H80000005&
         X1              =   0
         X2              =   5400
         Y1              =   15
         Y2              =   15
      End
      Begin VB.Label lblLight 
         AutoSize        =   -1  'True
         BackStyle       =   0  'Transparent
         Caption         =   "Homam babi"
         ForeColor       =   &H80000014&
         Height          =   195
         Left            =   270
         TabIndex        =   8
         Top             =   210
         Width           =   870
      End
   End
   Begin VB.Label Label4 
      AutoSize        =   -1  'True
      BackStyle       =   0  'Transparent
      Caption         =   "(The program may need to restart your computer)"
      Height          =   195
      Left            =   1605
      TabIndex        =   6
      Top             =   1455
      Width           =   3615
   End
   Begin VB.Label Label3 
      AutoSize        =   -1  'True
      BackStyle       =   0  'Transparent
      Caption         =   "setting the necessary system configurations."
      Height          =   195
      Left            =   1605
      TabIndex        =   5
      Top             =   1080
      Width           =   3240
   End
   Begin VB.Label Label2 
      AutoSize        =   -1  'True
      BackStyle       =   0  'Transparent
      Caption         =   "Press 'Install' button to start the installation, and"
      Height          =   195
      Left            =   1605
      TabIndex        =   4
      Top             =   840
      Width           =   3510
   End
   Begin VB.Label Label1 
      AutoSize        =   -1  'True
      BackStyle       =   0  'Transparent
      Caption         =   "Welcome to Homam AntiMalware Setup"
      BeginProperty Font 
         Name            =   "Tahoma"
         Size            =   8.25
         Charset         =   178
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   195
      Left            =   1605
      TabIndex        =   3
      Top             =   360
      Width           =   3360
   End
   Begin VB.Line Line3 
      Visible         =   0   'False
      X1              =   1440
      X2              =   1440
      Y1              =   120
      Y2              =   2760
   End
   Begin VB.Image imgSetup 
      Height          =   900
      Left            =   150
      Picture         =   "frmMain.frx":000C
      Top             =   240
      Width           =   1215
   End
End
Attribute VB_Name = "frmMain"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
'
' By Homam Babi - 2008
' humam_babi@hotmail.com
'
Option Base 1
Option Explicit

'Files constants
Private Const IDS_DATA_FILE = 101
Private Const IDS_UNINST_FILE = 102

'REG constants
Private Const IDS_REG_APPNAME = 130
Private Const IDS_REG_SECTION_SETTINGS = 131
Private Const IDS_REG_KEY_AUTODELETE = 132
Private Const IDS_REG_KEY_INSTALLED = 133
Private Const IDS_REG_KEY_MSG_STYLE = 134

'Messages language constants
Private Const IDS_MSG_ARCnFOUND = 140
Private Const IDS_MSG_PRV_FOUND = 141

'Labels caption
Private Const IDS_DEL_PREV = 150
Private Const IDS_INSTALLING = 151
Private Const IDS_SETTINGS = 152


Dim Finished    As Boolean
Dim NormalEnd   As Boolean
Dim pFound      As Boolean 'PrevCopy

Private Declare Sub Sleep Lib "kernel32" (ByVal dwMilliseconds As Long)
Private Sub Form_Load()
    SetIcon Me.hwnd, "AAA", True
        
    Me.Show: DoEvents
    DrawLines
    
    If CheckOSVer = False Then GoTo OutIt
    
    'Check for DatFile existance
    If FileExists(App.Path & IIf(Right$(App.Path, 1) = "\", "", "\") & LoadResString(IDS_DATA_FILE)) = False Then
        MsgBox LoadResString(IDS_MSG_ARCnFOUND), vbApplicationModal Or vbExclamation Or vbOKOnly, LoadResString(IDS_HAV_TITLE)
        
        Finished = True
        chkRestart.Value = vbUnchecked
        Unload Me
    End If
    
    Check4Scheduling
    CheckForPrevioushAV
OutIt:
End Sub
Private Sub CheckForPrevioushAV()
    Dim strResult   As String
    
    'components:
    ' - files: hav, unhav
    ' - windows startup run -> hav
    ' - windows uninstall db
    
    'If files exists (hav, unhav)
    If FileExists(GetWindowsDir() & LoadResString(IDS_APP_EXE)) Then
        pFound = True
        GoTo hAV_Found
    End If
    If FileExists(GetWindowsDir() & LoadResString(IDS_UNINST_FILE)) Then
        pFound = True
        GoTo hAV_Found
    End If
    
    'If existing in WindowsRun
    fEnumValue "HKLM", "SOFTWARE\Microsoft\Windows\CurrentVersion\Run", strResult
    If InStr(strResult, LoadResString(IDS_HAV_TITLE)) Then
        pFound = True
        GoTo hAV_Found
    End If
    strResult = ""
    
    'If existing in WindowsUninstall
    fEnumKey "HKLM", "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall", strResult
    If InStr(strResult, LoadResString(IDS_HAV_TITLE)) Then
        pFound = True
    End If
    
hAV_Found:
    If pFound = True Then
        MsgBox LoadResString(IDS_MSG_PRV_FOUND), vbApplicationModal Or vbExclamation Or vbOKOnly, LoadResString(IDS_HAV_TITLE)
    End If
End Sub
Private Sub PrepProgress()
    picProgress.BorderStyle = 0
    
    m_hProgBar = CreateWindowEx(0, PROGRESS_CLASS, vbNullString, WS_CHILD Or WS_VISIBLE Or 0, 0, 0, 0, 0, picProgress.hwnd, 0, App.hInstance, ByVal 0)
    MoveWindow m_hProgBar, 0, 0, picProgress.Width / 15, picProgress.Height / 15, True
  
    'Set the minimum and maximum ranges
    SendMessage m_hProgBar, PBM_SETRANGE, 0, ByVal 0
    SendMessage m_hProgBar, PBM_SETRANGE, 0, ByVal 100 * &H10000

    'Some othee initialization for the Status
    picPercent.BackColor = vbWhite
    picPercent.BorderStyle = 0
   
    SetProgress 0
    DoEvents
End Sub
Public Sub SetProgress(ByVal intValue As Long)
    If intValue < 0 Then intValue = 0
    If intValue > 100 Then intValue = 100
    SendMessage m_hProgBar, PBM_SETPOS, ByVal intValue, 0
    picPercent.Cls
    With picPercent
        .CurrentX = .Width - (.TextWidth(CStr(intValue) & "%")) ' - 15
    End With
    
    picPercent.Print CStr(intValue) & "%"
End Sub
Private Sub DrawLines()
    Dim Lp As Long
    Dim iStep As Long
    Dim iLen As Long
    
    iLen = Line3.Y2 - Line3.Y1
    iStep = iLen / 255
    
    For Lp = 255 To 0 Step -1
        Me.Line (Line3.X1, Line3.Y1 + ((255 - (Lp - 1)) * iStep))-(Line3.X2, Line3.Y1 + ((255 - Lp) * iStep)), RGB(255 - Lp, 255 - Lp, 255 - Lp)
        Me.Line (Line3.X1 - 30, Line3.Y1 + ((255 - (Lp - 1)) * iStep))-(Line3.X2 - 30, Line3.Y1 + ((255 - Lp) * iStep)), RGB(255 - Lp, 255 - Lp, 255 - Lp)
    Next Lp
End Sub
Private Sub cmdExit_Click()
    Unload Me
End Sub
Private Sub CopyEXEs()
CheckP:
    If FileExists(GetWindowsDir() & LoadResString(IDS_APP_EXE)) Then
        If Delete(GetWindowsDir() & LoadResString(IDS_APP_EXE)) = False Then
            frmRun.Show vbModal, frmMain
            GoTo CheckP
        End If
    End If

CheckU:
    If FileExists(GetWindowsDir() & LoadResString(IDS_UNINST_FILE)) Then
        If Delete(GetWindowsDir() & LoadResString(IDS_UNINST_FILE)) = False Then
            frmRun.Show vbModal, frmMain
            GoTo CheckU
        End If
    End If
        
    Dim Dat()   As Byte
    Dim Src     As Integer
    Dim Adst    As Integer
    Dim Udst    As Integer
    Dim ALen    As Long
    Dim ULen    As Long
    
    On Error Resume Next
    
    Src = FreeFile: Adst = FreeFile: Udst = FreeFile
    Open App.Path & IIf(Left$(App.Path, 1) = "\", "", "\") & LoadResString(IDS_DATA_FILE) For Binary Access Read As #1
        Get #1, , ALen
        Get #1, , ULen
         
        'Get First file (which should be hAV.EXE)
        ReDim Dat(ALen)
        Get #1, , Dat
        Open GetWindowsDir() & LoadResString(IDS_APP_EXE) For Binary Access Write As #2
            Put #2, , Dat
        Close #2

        'Get Second file (which should be UnhAV.EXE)
        ReDim Dat(ULen)
        Get #1, , Dat
        Open GetWindowsDir() & LoadResString(IDS_UNINST_FILE) For Binary Access Write As #2
            Put #2, , Dat
        Close #2
    Close #1
End Sub
Private Sub Form_Unload(Cancel As Integer)
    If Finished Then
        If chkRestart.Value = vbChecked Then
            Shell "shutdown -r -t 0"
            DoEvents
        Else
            If NormalEnd = True Then
                On Local Error Resume Next
                Shell GetWindowsDir() & LoadResString(IDS_APP_EXE), vbNormalFocus
                DoEvents
            End If
        End If
    End If
    
    End
End Sub
Private Sub Form_QueryUnload(Cancel As Integer, UnloadMode As Integer)
    If Finished = False Then
        If MsgBox(LoadResString(IDS_SURE_EXIT), vbApplicationModal Or vbQuestion Or vbYesNo Or vbDefaultButton2, LoadResString(IDS_HAV_TITLE)) = vbNo Then
            Cancel = True
        End If
    End If
End Sub
Private Sub DeletePreviousVer()
    '- files: hav, unhav (no need, since we'll do that soon)
    '- disabled autorun (no need because we are installing again)
    '- appSettings (no need because they'll be reset during setup)
    '* windows run -> hav
    '* windows uninstall db
    '(delete the last two to not dublicate them)
    
    On Error Resume Next
        
    '1- Delete WindowsRun
    fDeleteValue "HKLM", "SOFTWARE\Microsoft\Windows\CurrentVersion\Run", LoadResString(IDS_HAV_TITLE)
        
    '2- Delete WindowsUninst
    fDeleteKey "HKLM", "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall", LoadResString(IDS_HAV_TITLE)
End Sub
Private Sub cmdSetup_Click()
    Dim R   As Long
    
    cmdSetup.Enabled = False
    cmdExit.Enabled = False
    
    PrepProgress
    
    picAction.BorderStyle = 0
    picAction.Top = 120
    picAction.Left = 1600
    DoEvents
    
    SetProgress 1: DoEvents
    
    'Del Previous               -> 15
    If pFound = True Then
        lblAction.Caption = LoadResString(IDS_DEL_PREV)
        DeletePreviousVer
        SetProgress 15: DoEvents
    End If
    
    'Extract Files              -> 30
    lblAction.Caption = LoadResString(IDS_INSTALLING)
    CopyEXEs
    If pFound = False Then
        SetProgress 15: DoEvents: Sleep 500
    End If
    SetProgress 30: DoEvents: Sleep 500
    
    'Disable Autorun            -> 45
    lblAction.Caption = LoadResString(IDS_SETTINGS)
    fWriteValue "HKCU", "Software\Microsoft\Windows\CurrentVersion\Policies\Explorer", "NoDriveTypeAutoRun", "D", 12 'Hard=8, Removable=4
    SetProgress 45: DoEvents: Sleep 250
    
    'Set App.settings           -> 60
    SaveSetting LoadResString(IDS_REG_APPNAME), LoadResString(IDS_REG_SECTION_SETTINGS), LoadResString(IDS_REG_KEY_AUTODELETE), vbUnchecked
    SaveSetting LoadResString(IDS_REG_APPNAME), LoadResString(IDS_REG_SECTION_SETTINGS), LoadResString(IDS_REG_KEY_INSTALLED), True
    SaveSetting LoadResString(IDS_REG_APPNAME), LoadResString(IDS_REG_SECTION_SETTINGS), LoadResString(IDS_REG_KEY_MSG_STYLE), True
    SetProgress 60: DoEvents: Sleep 250
    
    'Put in WinAutorun -> 75
    fWriteValue "HKLM", "SOFTWARE\Microsoft\Windows\CurrentVersion\Run", LoadResString(IDS_HAV_TITLE), "S", GetWindowsDir() & LoadResString(IDS_APP_EXE)
    SetProgress 75: DoEvents: Sleep 250
    
    'Write the uninstall string -> 90
    CreateKey "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\" & LoadResString(IDS_HAV_TITLE)
        fWriteValue "HKLM", "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\" & LoadResString(IDS_HAV_TITLE), "Contact", "S", "humam_babi@hotmail.com"
        fWriteValue "HKLM", "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\" & LoadResString(IDS_HAV_TITLE), "DisplayIcon", "S", Chr$(34) & GetWindowsDir() & LoadResString(IDS_APP_EXE) & Chr$(34)
        fWriteValue "HKLM", "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\" & LoadResString(IDS_HAV_TITLE), "DisplayName", "S", LoadResString(IDS_HAV_TITLE)
        fWriteValue "HKLM", "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\" & LoadResString(IDS_HAV_TITLE), "Publisher", "S", "Homam Babi"
        fWriteValue "HKLM", "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\" & LoadResString(IDS_HAV_TITLE), "UninstallString", "S", Chr$(34) & GetWindowsDir() & LoadResString(IDS_UNINST_FILE) & Chr$(34)
        fWriteValue "HKLM", "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\" & LoadResString(IDS_HAV_TITLE), "DisplayVersion", "S", GethAVVersion(GetWindowsDir() & LoadResString(IDS_APP_EXE))
        fWriteValue "HKLM", "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\" & LoadResString(IDS_HAV_TITLE), "NoModify", "D", 1
        fWriteValue "HKLM", "SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\" & LoadResString(IDS_HAV_TITLE), "NoRepair", "D", 1
    SetProgress 100: DoEvents: Sleep 1000
    
    'Restart
    picFinish.BorderStyle = 0
    picAction.Visible = False
    
    picFinish.Left = 1600
    picFinish.Top = 120
    
    cmdExit.Enabled = True
    Finished = True
    NormalEnd = True
End Sub
